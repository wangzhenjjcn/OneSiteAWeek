# Pornhub视频数据抓取工具 - 使用说明

## 项目概述

这是一个专门用于抓取Pornhub网站视频数据的Python工具。该工具能够：

- 抓取视频列表页面的所有视频信息
- 下载视频缩略图和预览视频
- 为每个视频创建独立的HTML展示页面
- 使用socks5代理进行网络请求
- 支持分页抓取（使用新的URL格式：`/language/chinese?page=`）
- **自动分页检测**: 智能检测最后一页，自动抓取所有数据（约749个视频）
- **SSL安全忽略**: 完全忽略SSL证书验证、域名检查等安全验证
- **智能重连机制**: 连接失败时自动重试，针对不同错误类型采用不同等待时间
- **智能跳过机制**: 自动跳过已采集完成的视频，避免重复处理
- **采集日志记录**: 每个视频文件夹中保存详细的采集日志
- **鼠标悬停自动播放预览视频**
- **多线程并发下载（30个线程）**
- **智能下载队列管理**
- **静默工作模式**: 隐藏子进程运行信息，只显示错误信息

## 文件结构

```
pronhub.com/
├── app.py              # 主程序文件
├── config.py           # 配置文件
├── requirements.txt    # Python依赖包
├── README.md          # 英文说明文档
├── 使用说明.md        # 中文使用说明
├── example.py         # 使用示例
├── test.py            # 测试脚本
└── run.bat            # Windows启动脚本
```

## 快速开始

### 1. 环境准备

确保您的系统已安装Python 3.7或更高版本。

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

### 3. 配置代理

确保socks5代理服务器运行在 `127.0.0.1:12345`，或修改 `config.py` 中的代理设置：

```python
PROXY_CONFIG = {
    'http': 'socks5://127.0.0.1:12345',
    'https': 'socks5://127.0.0.1:12345'
}
```

### 4. 运行程序

#### Windows用户：
双击 `run.bat` 文件，或在命令行中运行：
```bash
python app.py
```

#### 其他系统：
```bash
python app.py
```

## 配置说明

### 主要配置项 (config.py)

```python
# 抓取设置
SCRAPER_CONFIG = {
    'start_page': 1,      # 开始页数
    'end_page': 5,        # 结束页数（当auto_detect_last=True时会被忽略）
    'delay_min': 1,       # 最小延迟秒数
    'delay_max': 3,       # 最大延迟秒数
    'timeout': 30,        # 请求超时时间
    'max_retries': 5,     # 最大重试次数（增加到5次）
    'auto_detect_last': True,  # 是否自动检测最后一页
    'download_threads': 30,  # 下载线程数（增加到30个）
    'skip_existing': True,  # 是否跳过已存在的ID
    'show_worker_info': False,  # 是否显示工作线程信息
}

# SSL设置
SSL_CONFIG = {
    'verify': False,  # 不验证SSL证书
    'check_hostname': False,  # 不检查主机名
    'allow_redirects': True,  # 允许重定向
}

# 输出设置
OUTPUT_CONFIG = {
    'data_folder': 'data',           # 数据保存文件夹
    'html_filename': 'index.html',   # HTML文件名
    'thumbnail_filename': 'thumbnail.jpg',  # 缩略图文件名
    'preview_filename': 'preview.webm',     # 预览视频文件名
}
```

## 输出结果

程序运行后会在 `app.py` 所在目录下创建 `data` 文件夹，每个视频以viewkey为文件夹名：

```
data/
├── 6870540048f36/
│   ├── index.html          # 视频信息页面
│   ├── thumbnail.jpg       # 缩略图
│   ├── preview.webm        # 预览视频
│   └── collection_log.txt  # 采集日志
├── 6870540048f37/
│   ├── index.html
│   ├── thumbnail.jpg
│   ├── preview.webm
│   └── collection_log.txt
└── ...
```

### HTML页面内容

每个视频文件夹中的 `index.html` 包含：

- 视频标题和基本信息
- 缩略图显示（支持鼠标悬停自动播放预览视频）
- 预览视频播放器
- 下载链接
- 原始页面链接

#### 鼠标悬停自动播放功能

- 将鼠标悬停在缩略图上时，会自动播放预览视频
- 移开鼠标时，视频会暂停并重置到开始位置
- 视频播放时静音，避免意外声音
- 支持循环播放

## 抓取的数据字段

每个视频包含以下信息：

- **video_id**: 视频ID
- **viewkey**: 视频唯一标识
- **title**: 视频标题
- **video_url**: 原始视频页面链接
- **thumbnail_url**: 缩略图URL
- **alt_text**: 缩略图描述
- **preview_url**: 预览视频URL（可能为空，取决于视频是否有预览）
- **duration**: 视频时长
- **uploader**: 上传者
- **views**: 观看次数
- **added_time**: 上传时间
- **publish_time**: 准确发布时间
- **categories**: 分类信息
- **best_m3u8_url**: 最佳质量m3u8地址

### 采集日志说明

每个视频文件夹中的 `collection_log.txt` 包含：

```
采集日志
================

采集时间: 2024-01-15 14:30:25
视频ID: 471425945
ViewKey: 686b24c4659e9
视频标题: 一早就被肥美的蜜桃臀用各种姿势主动榨干 💀...
视频链接: https://cn.pornhub.com/view_video.php?viewkey=686b24c4659e9

采集信息:
- 缩略图: 已下载
- 预览视频: 已下载
- 发布时间: 1个月前
- 分类数量: 11
- m3u8地址: 已获取

采集状态: 成功
```

**采集状态说明**:
- **成功**: 所有文件下载成功，HTML页面创建完成
- **失败**: 部分文件下载失败或处理过程中出错
- **处理中**: 正在处理该视频

### 预览视频URL说明

预览视频URL的提取逻辑：
1. 优先从 `data-mediabook` 属性获取
2. 如果为空，尝试 `data-preview`、`data-video-preview`、`data-video-src` 等属性
3. 最后尝试从其他相关元素获取
4. 自动清理HTML实体编码

**注意**: 并非所有视频都有预览视频，这是正常现象。

## 使用示例

### 基本使用
```python
from app import PornhubScraper

scraper = PornhubScraper()
scraper.run()  # 使用默认配置
```

### 自定义页数
```python
scraper = PornhubScraper()
scraper.run(start_page=1, end_page=3)  # 只抓取第1-3页
```

### 单页抓取
```python
scraper = PornhubScraper()
videos = scraper.scrape_pages(start_page=2, end_page=2)
for video in videos:
    scraper.process_video(video)
```

## 高级功能

### 1. 测试模式
运行 `test.py` 进行功能测试：
```bash
python test.py
```

### 2. 示例程序
运行 `example.py` 查看各种使用示例：
```bash
python example.py
```

### 3. 预览视频URL测试
运行 `test_preview.py` 测试预览视频URL提取：
```bash
python test_preview.py
```

### 4. HTML结构分析
运行 `debug_preview.py` 分析HTML结构：
```bash
python debug_preview.py
```

### 5. 路径测试
运行 `test_path.py` 测试data文件夹路径设置：
```bash
python test_path.py
```

### 6. SSL验证测试
运行 `test_ssl.py` 测试代理SSL连接：
```bash
python test_ssl.py
```

### 7. 多线程下载测试
运行 `test_multithread.py` 测试多线程下载功能：
```bash
python test_multithread.py
```

### 8. 新URL格式测试
运行 `test_new_url.py` 测试新的URL格式：
```bash
python test_new_url.py
```

### 9. 自动分页功能测试
运行 `test_auto_pagination.py` 测试自动分页功能：
```bash
python test_auto_pagination.py
```

### 10. 自动分页示例
运行 `example_auto_pagination.py` 查看自动分页功能示例：
```bash
python example_auto_pagination.py
```

### 11. SSL忽略和重连测试
运行 `test_ssl_robust.py` 测试SSL忽略和重连机制：
```bash
python test_ssl_robust.py
```

### 12. 跳过已存在ID测试
运行 `test_skip_existing.py` 测试跳过已存在ID功能：
```bash
python test_skip_existing.py
```

### 3. 调试模式
在 `config.py` 中修改调试设置：
```python
DEBUG = {
    'verbose': True,      # 详细输出
    'save_raw_html': False,  # 保存原始HTML
    'test_mode': False,   # 测试模式
}
```

## 注意事项

### 1. 网络要求
- 确保socks5代理服务器正常运行
- 网络连接稳定，避免频繁断线
- 建议在网络较好的环境下运行

### 2. 使用规范
- 请遵守网站的使用条款
- 建议添加适当的延迟，避免对服务器造成压力
- 抓取的内容仅供学习和研究使用

### 3. 错误处理
程序包含完善的错误处理机制：
- 网络请求失败时会记录错误
- 解析失败时会跳过该视频继续处理
- 下载失败时会记录详细信息

### 4. 性能优化
- 程序使用随机延迟避免被封
- 支持断点续传（重新运行时会跳过已处理的视频）
- 内存使用优化，适合长时间运行
- **多线程并发下载**：使用10个线程同时处理下载任务
- **智能队列管理**：自动分配下载任务，提高效率
- **下载统计**：实时显示下载进度和成功率

## 常见问题

### Q: 代理连接失败
A: 检查socks5代理服务器是否正常运行，确认端口12345是否开放

### Q: 抓取速度慢
A: 可以在config.py中调整延迟设置，但建议保持适当延迟避免被封

### Q: 某些视频下载失败
A: 这是正常现象，某些视频可能因为各种原因无法下载，程序会自动跳过

### Q: HTML页面显示异常
A: 确保浏览器支持现代HTML5特性，建议使用Chrome或Firefox

## 技术支持

如果遇到问题，请检查：
1. Python版本是否为3.7+
2. 所有依赖包是否正确安装
3. 代理服务器是否正常运行
4. 网络连接是否稳定

## 更新日志

- v1.0: 初始版本，支持基本抓取功能
- 支持socks5代理
- 支持分页抓取
- 支持HTML页面生成
- 支持缩略图和预览视频下载 
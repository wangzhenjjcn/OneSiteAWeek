# æ–°åŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°æ·»åŠ äº†æ™ºèƒ½è·³è¿‡æœºåˆ¶ã€é‡‡é›†æ—¥å¿—è®°å½•ã€é™é»˜å·¥ä½œæ¨¡å¼ç­‰åŠŸèƒ½ï¼Œæå‡äº†ç¨‹åºçš„ç¨³å®šæ€§å’Œç”¨æˆ·ä½“éªŒã€‚

## æ–°å¢åŠŸèƒ½

### 1. æ™ºèƒ½è·³è¿‡æœºåˆ¶

**åŠŸèƒ½æè¿°**: è‡ªåŠ¨è·³è¿‡å·²ç»é‡‡é›†å®Œæˆçš„è§†é¢‘ï¼Œé¿å…é‡å¤å¤„ç†

**å®ç°åŸç†**:
- æ£€æŸ¥æ¯ä¸ªè§†é¢‘æ–‡ä»¶å¤¹ä¸­çš„ `collection_log.txt` æ–‡ä»¶
- å¦‚æœæ—¥å¿—æ–‡ä»¶å­˜åœ¨ä¸”åŒ…å«"é‡‡é›†çŠ¶æ€: æˆåŠŸ"ï¼Œåˆ™è·³è¿‡è¯¥è§†é¢‘
- å¦‚æœæ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨æˆ–çŠ¶æ€ä¸ºå¤±è´¥ï¼Œåˆ™é‡æ–°å¤„ç†

**é…ç½®é€‰é¡¹**:
```python
SCRAPER_CONFIG = {
    'skip_existing': True,  # æ˜¯å¦è·³è¿‡å·²å­˜åœ¨çš„ID
}
```

**ä¼˜åŠ¿**:
- èŠ‚çœæ—¶é—´å’Œç½‘ç»œèµ„æº
- æ”¯æŒæ–­ç‚¹ç»­ä¼ 
- é¿å…é‡å¤ä¸‹è½½

### 2. é‡‡é›†æ—¥å¿—è®°å½•

**åŠŸèƒ½æè¿°**: ä¸ºæ¯ä¸ªè§†é¢‘åˆ›å»ºè¯¦ç»†çš„é‡‡é›†æ—¥å¿—ï¼Œè®°å½•é‡‡é›†è¿‡ç¨‹å’Œç»“æœ

**æ—¥å¿—å†…å®¹**:
```
é‡‡é›†æ—¥å¿—
================

é‡‡é›†æ—¶é—´: 2024-01-15 14:30:25
è§†é¢‘ID: 471425945
ViewKey: 686b24c4659e9
è§†é¢‘æ ‡é¢˜: ä¸€æ—©å°±è¢«è‚¥ç¾çš„èœœæ¡ƒè‡€ç”¨å„ç§å§¿åŠ¿ä¸»åŠ¨æ¦¨å¹² ğŸ’€...
è§†é¢‘é“¾æ¥: https://cn.pornhub.com/view_video.php?viewkey=686b24c4659e9

é‡‡é›†ä¿¡æ¯:
- ç¼©ç•¥å›¾: å·²ä¸‹è½½
- é¢„è§ˆè§†é¢‘: å·²ä¸‹è½½
- å‘å¸ƒæ—¶é—´: 1ä¸ªæœˆå‰
- åˆ†ç±»æ•°é‡: 11
- m3u8åœ°å€: å·²è·å–

é‡‡é›†çŠ¶æ€: æˆåŠŸ
```

**æ—¥å¿—çŠ¶æ€**:
- **æˆåŠŸ**: æ‰€æœ‰æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼ŒHTMLé¡µé¢åˆ›å»ºå®Œæˆ
- **å¤±è´¥**: éƒ¨åˆ†æ–‡ä»¶ä¸‹è½½å¤±è´¥æˆ–å¤„ç†è¿‡ç¨‹ä¸­å‡ºé”™
- **å¤„ç†ä¸­**: æ­£åœ¨å¤„ç†è¯¥è§†é¢‘

**ä¼˜åŠ¿**:
- è¯¦ç»†è®°å½•é‡‡é›†è¿‡ç¨‹
- ä¾¿äºé—®é¢˜æ’æŸ¥
- æ”¯æŒé‡‡é›†çŠ¶æ€æ£€æŸ¥

### 3. é™é»˜å·¥ä½œæ¨¡å¼

**åŠŸèƒ½æè¿°**: éšè—å­è¿›ç¨‹è¿è¡Œä¿¡æ¯ï¼Œåªæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼Œè¿‡æ»¤ç©ºé”™è¯¯å’Œè¶…æ—¶

**é…ç½®é€‰é¡¹**:
```python
SCRAPER_CONFIG = {
    'show_worker_info': False,  # æ˜¯å¦æ˜¾ç¤ºå·¥ä½œçº¿ç¨‹ä¿¡æ¯
}

DEBUG = {
    'verbose': False,  # æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
}
```

**æ˜¾ç¤ºå†…å®¹**:
- âœ… æˆåŠŸä¿¡æ¯: éšè—ï¼ˆé™¤éå¯ç”¨æ˜¾ç¤ºï¼‰
- âŒ é”™è¯¯ä¿¡æ¯: è¿‡æ»¤åæ˜¾ç¤ºï¼ˆå¿½ç•¥ç©ºé”™è¯¯ã€è¶…æ—¶ç­‰ï¼‰
- ğŸ“Š ç»Ÿè®¡ä¿¡æ¯: å§‹ç»ˆæ˜¾ç¤º
- ğŸ”§ çº¿ç¨‹çŠ¶æ€: éšè—ï¼ˆé™¤éå¯ç”¨æ˜¾ç¤ºï¼‰

**é”™è¯¯è¿‡æ»¤è§„åˆ™**:
- å¿½ç•¥åŒ…å« "timeout" çš„é”™è¯¯
- å¿½ç•¥åŒ…å« "empty" çš„é”™è¯¯  
- å¿½ç•¥åŒ…å« "none" çš„é”™è¯¯
- åªæ˜¾ç¤ºçœŸæ­£çš„ç½‘ç»œé”™è¯¯å’Œç¨‹åºé”™è¯¯

**ä¼˜åŠ¿**:
- å‡å°‘è¾“å‡ºå™ªéŸ³
- çªå‡ºé‡è¦ä¿¡æ¯
- æå‡ç”¨æˆ·ä½“éªŒ
- é¿å…é¢‘ç¹çš„çŠ¶æ€æ›´æ–°

### 4. ä¸‹è½½çº¿ç¨‹æ•°å¢åŠ 

**åŠŸèƒ½æè¿°**: å°†ä¸‹è½½çº¿ç¨‹æ•°ä»10ä¸ªå¢åŠ åˆ°30ä¸ª

**é…ç½®é€‰é¡¹**:
```python
SCRAPER_CONFIG = {
    'download_threads': 30,  # ä¸‹è½½çº¿ç¨‹æ•°ï¼ˆå¢åŠ åˆ°30ä¸ªï¼‰
}
```

**ä¼˜åŠ¿**:
- æé«˜ä¸‹è½½æ•ˆç‡
- å‡å°‘ç­‰å¾…æ—¶é—´
- æ›´å¥½çš„å¹¶å‘å¤„ç†

## æŠ€æœ¯å®ç°

### 1. è·³è¿‡æœºåˆ¶å®ç°

```python
def is_video_completed(self, viewkey):
    """æ£€æŸ¥è§†é¢‘æ˜¯å¦å·²å®Œæˆé‡‡é›†"""
    try:
        log_file = os.path.join(folder_path, 'collection_log.txt')
        if not os.path.exists(log_file):
            return False
        
        with open(log_file, 'r', encoding='utf-8') as f:
            content = f.read()
        
        return 'é‡‡é›†çŠ¶æ€: æˆåŠŸ' in content
    except Exception as e:
        return False
```

### 2. æ—¥å¿—è®°å½•å®ç°

```python
def create_collection_log(self, video_data, folder_path, success=True, error_msg=''):
    """åˆ›å»ºé‡‡é›†æ—¥å¿—"""
    current_time = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    
    log_content = f"""é‡‡é›†æ—¥å¿—
================

é‡‡é›†æ—¶é—´: {current_time}
è§†é¢‘ID: {video_data.get('video_id', 'N/A')}
ViewKey: {video_data.get('viewkey', 'N/A')}
è§†é¢‘æ ‡é¢˜: {video_data.get('title', 'N/A')}
è§†é¢‘é“¾æ¥: {video_data.get('video_url', 'N/A')}

é‡‡é›†ä¿¡æ¯:
- ç¼©ç•¥å›¾: {'å·²ä¸‹è½½' if video_data.get('thumbnail_url') else 'æ— '}
- é¢„è§ˆè§†é¢‘: {'å·²ä¸‹è½½' if video_data.get('preview_url') else 'æ— '}
- å‘å¸ƒæ—¶é—´: {video_data.get('publish_time', 'N/A')}
- åˆ†ç±»æ•°é‡: {len(video_data.get('categories', []))}
- m3u8åœ°å€: {'å·²è·å–' if video_data.get('best_m3u8_url') else 'æ— '}

é‡‡é›†çŠ¶æ€: {'æˆåŠŸ' if success else 'å¤±è´¥'}
"""
    
    with open(log_file, 'w', encoding='utf-8') as f:
        f.write(log_content)
```

### 3. é™é»˜æ¨¡å¼å®ç°

```python
def download_worker(self, worker_id):
    """ä¸‹è½½å·¥ä½œçº¿ç¨‹"""
    while True:
        try:
            task = self.download_queue.get(timeout=1)
            if task is None:
                break
            
            url, filepath, task_type = task
            
            # åªåœ¨æ˜¾ç¤ºå·¥ä½œçº¿ç¨‹ä¿¡æ¯æ—¶è¾“å‡º
            if SCRAPER_CONFIG.get('show_worker_info', False):
                print(f"çº¿ç¨‹ {worker_id}: å¼€å§‹ä¸‹è½½ {task_type}")
            
            success = self.download_file(url, filepath)
            
            with self.download_lock:
                self.download_results[filepath] = success
                if success and SCRAPER_CONFIG.get('show_worker_info', False):
                    print(f"çº¿ç¨‹ {worker_id}: âœ“ {task_type} ä¸‹è½½æˆåŠŸ")
                elif not success:
                    print(f"çº¿ç¨‹ {worker_id}: âœ— {task_type} ä¸‹è½½å¤±è´¥")
                    
        except Exception as e:
            # åªæ˜¾ç¤ºçœŸæ­£çš„é”™è¯¯ï¼Œå¿½ç•¥ç©ºé”™è¯¯å’Œè¶…æ—¶
            if str(e) and not any(empty_error in str(e).lower() for empty_error in ['timeout', 'empty', 'none']):
                print(f"çº¿ç¨‹ {worker_id} é”™è¯¯: {e}")
```

**é”™è¯¯è¿‡æ»¤å®ç°**:
```python
# é”™è¯¯è¿‡æ»¤é€»è¾‘
if str(e) and not any(empty_error in str(e).lower() for empty_error in ['timeout', 'empty', 'none']):
    print(f"çº¿ç¨‹ {worker_id} é”™è¯¯: {e}")
```

**é™é»˜æ¨¡å¼æ§åˆ¶**:
```python
# å¯åŠ¨çº¿ç¨‹æ—¶
if DEBUG['verbose']:
    print(f"å¯åŠ¨ {num_threads} ä¸ªä¸‹è½½çº¿ç¨‹")

# åœæ­¢çº¿ç¨‹æ—¶  
if DEBUG['verbose']:
    print("æ‰€æœ‰ä¸‹è½½çº¿ç¨‹å·²åœæ­¢")
```

## ä½¿ç”¨æ–¹æ³•

### 1. å¯ç”¨è·³è¿‡åŠŸèƒ½ï¼ˆé»˜è®¤å¯ç”¨ï¼‰

```python
# åœ¨config.pyä¸­è®¾ç½®
SCRAPER_CONFIG = {
    'skip_existing': True,  # è·³è¿‡å·²å­˜åœ¨çš„ID
}
```

### 2. å¯ç”¨é™é»˜æ¨¡å¼ï¼ˆé»˜è®¤å¯ç”¨ï¼‰

```python
# åœ¨config.pyä¸­è®¾ç½®
SCRAPER_CONFIG = {
    'show_worker_info': False,  # éšè—å·¥ä½œçº¿ç¨‹ä¿¡æ¯
}

DEBUG = {
    'verbose': False,  # éšè—è¯¦ç»†ä¿¡æ¯
}
```

### 3. å¯ç”¨è¯¦ç»†æ¨¡å¼ï¼ˆè°ƒè¯•æ—¶ä½¿ç”¨ï¼‰

```python
# åœ¨config.pyä¸­è®¾ç½®
SCRAPER_CONFIG = {
    'show_worker_info': True,  # æ˜¾ç¤ºå·¥ä½œçº¿ç¨‹ä¿¡æ¯
}

DEBUG = {
    'verbose': True,  # æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
}
```

### 3. æŸ¥çœ‹é‡‡é›†æ—¥å¿—

```bash
# æŸ¥çœ‹ç‰¹å®šè§†é¢‘çš„é‡‡é›†æ—¥å¿—
cat data/686b24c4659e9/collection_log.txt
```

### 4. æ‰‹åŠ¨æ£€æŸ¥é‡‡é›†çŠ¶æ€

```python
from app import PornhubScraper

scraper = PornhubScraper()
is_completed = scraper.is_video_completed('686b24c4659e9')
print(f"è§†é¢‘æ˜¯å¦å·²å®Œæˆ: {is_completed}")
```

## æµ‹è¯•è„šæœ¬

### 1. è·³è¿‡åŠŸèƒ½æµ‹è¯•

```bash
python test_skip_existing.py
```

### 2. å®Œæ•´åŠŸèƒ½æµ‹è¯•

```bash
python app.py
```

## æ³¨æ„äº‹é¡¹

1. **æ—¥å¿—æ–‡ä»¶**: æ¯ä¸ªè§†é¢‘æ–‡ä»¶å¤¹éƒ½ä¼šåˆ›å»º `collection_log.txt` æ–‡ä»¶
2. **è·³è¿‡é€»è¾‘**: åªæœ‰çŠ¶æ€ä¸º"æˆåŠŸ"çš„è§†é¢‘æ‰ä¼šè¢«è·³è¿‡
3. **é”™è¯¯å¤„ç†**: æ‰€æœ‰é”™è¯¯ä¿¡æ¯éƒ½ä¼šæ­£å¸¸æ˜¾ç¤ºï¼Œä¸å—é™é»˜æ¨¡å¼å½±å“
4. **æ€§èƒ½å½±å“**: 30ä¸ªä¸‹è½½çº¿ç¨‹å¯èƒ½ä¼šå¢åŠ ç³»ç»Ÿè´Ÿè½½ï¼Œè¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´

## å…¼å®¹æ€§

- âœ… Python 3.7+
- âœ… Windows/Linux/macOS
- âœ… ä¸ç°æœ‰åŠŸèƒ½å®Œå…¨å…¼å®¹
- âœ… å‘åå…¼å®¹æ—§ç‰ˆæœ¬æ•°æ®

## æ›´æ–°æ—¥å¿—

### v2.0.0 (2024-01-15)
- âœ¨ æ–°å¢æ™ºèƒ½è·³è¿‡æœºåˆ¶
- âœ¨ æ–°å¢é‡‡é›†æ—¥å¿—è®°å½•
- âœ¨ æ–°å¢é™é»˜å·¥ä½œæ¨¡å¼
- âš¡ ä¸‹è½½çº¿ç¨‹æ•°å¢åŠ åˆ°30ä¸ª
- ğŸ”§ ä¼˜åŒ–é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- ğŸ“ å®Œå–„æ–‡æ¡£å’Œæµ‹è¯•è„šæœ¬ 